# ==============================================================================
# DOCKER COMPOSE - Local production environment
# ==============================================================================
# Defines and orchestrates multiple containers (app + database) for local prod

services:
  # ===========================================================================
  # APPLICATION SERVICE - NestJS API in production mode
  # ===========================================================================
  production:
    # Container name: Used to reference this container (e.g., docker logs api-gifty-nestjs-prod)
    container_name: api-gifty-nestjs-prod

    # Build configuration
    build:
      # Dockerfile to use (the one with multi-stage builds)
      dockerfile: Dockerfile
      # Build context: Directory containing source code and Dockerfile
      # . means current directory
      context: .

      # Target stage: Uses the "production" stage from Dockerfile
      # This stage includes hot-reload and debugging tools
      target: production

    # Environment variables: Define runtime configuration for the container
    environment:
      # Example: NODE_ENV sets the mode (development, test, production)
      - NODE_ENV=production

    # Port mapping: host:container
    # Exposes container ports to your local machine
    ports:
      # Application port (value from .env file)
      - ${PORT}:${PORT}

    # Service dependencies: Wait for mongo before starting app
    # Ensures database is ready before app tries to connect
    # Note: "depends_on" only waits for container start, not full readiness
    depends_on:
      - mongo

  # ===========================================================================
  # DATABASE SERVICE - MongoDB for local development
  # ===========================================================================
  mongo:
    # Use official MongoDB image from Docker Hub (latest version)
    # Production should pin specific version (e.g., mongo:7.0)
    image: mongo:latest

    # Container name for easy reference
    container_name: mymongodb
    # Restart policy (currently disabled)
    # restart: always

    # Port mapping: Makes MongoDB accessible from host machine
    # localhost:27017 â†’ container:27017
    # Connection string: mongodb://localhost:27017
    ports:
      - 27017:27017

    # Persistent storage: Data survives container restarts/rebuilds
    volumes:
      # Database files: Stored in ./mongo directory on host
      # Survives "docker-compose down" (but not "docker-compose down -v")
      - ./mongo:/data/db
      # MongoDB logs: Stored in ./mongo/log directory
      # Useful for debugging database issues
      - ./mongo/log:/var/log/mongodb/

# ==============================================================================
# NAMED VOLUMES (currently unused but declared)
# ==============================================================================
# Named volumes can be shared between containers
# Example usage: volumes: [node_modules:/usr/src/app/node_modules]
volumes:
  node_modules:

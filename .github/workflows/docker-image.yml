name: Build and Push Docker Image

# Trigger: This workflow runs when code is pushed to main or production branches
on:
  push:
    branches: [main, dev]
  # pull_request:
  #   branches: [main]

jobs:
  build:
    # Runner: Uses the latest Ubuntu virtual machine provided by GitHub
    runs-on: ubuntu-latest
    # Environment selection: Uses 'development' for dev branch, 'production' for main
    # This allows using the same secret names (e.g., DATABASE_URI) with different values per environment
    environment:
      name: ${{ github.ref == 'refs/heads/dev' && 'development' || 'production' }}

    steps:
      # Step 1: Clone the repository code into the runner
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Determine environment variables based on the branch
      - name: Set environment based on branch
        id: set-env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "image_tag=development" >> $GITHUB_OUTPUT
          else
            echo "image_tag=production" >> $GITHUB_OUTPUT
          fi

      # Step 3: Authenticate with Docker Hub using credentials stored in GitHub Secrets
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 4: Build the Docker image
      # --build-arg: Pass environment variables as build arguments to the Dockerfile
      # -f: Specify which Dockerfile to use (Dockerfile.prod instead of default Dockerfile)
      # --target: Use multi-stage build and stop at the 'production' stage
      # -t: Tag the image with username/image-name:commit-hash format
      # .: Use current directory as build context
      - name: Build the Docker image
        run: |
          docker build \
            --build-arg PORT=${{ secrets.PORT }} \
            --build-arg API_KEY=${{ secrets.API_KEY }} \
            --build-arg PREFIX=${{ secrets.PREFIX }} \
            --build-arg FRONTEND_URL=${{ secrets.FRONTEND_URL }} \
            --build-arg JWT_SECRET=${{ secrets.JWT_SECRET }} \
            --build-arg JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN }} \
            --build-arg REFRESH_JWT_SECRET=${{ secrets.REFRESH_JWT_SECRET }} \
            --build-arg REFRESH_JWT_EXPIRES_IN=${{ secrets.REFRESH_JWT_EXPIRES_IN }} \
            --build-arg MAIL_JWT_SECRET=${{ secrets.MAIL_JWT_SECRET }} \
            --build-arg MAIL_JWT_EXPIRES_IN=${{ secrets.MAIL_JWT_EXPIRES_IN }} \
            --build-arg PASSWORD_JWT_SECRET=${{ secrets.PASSWORD_JWT_SECRET }} \
            --build-arg PASSWORD_JWT_EXPIRES_IN=${{ secrets.PASSWORD_JWT_EXPIRES_IN }} \
            --build-arg DATABASE_URI=${{ secrets.DATABASE_URI }} \
            --build-arg DATABASE_NAME=${{ secrets.DATABASE_NAME }} \
            --build-arg DEFAULT_USER_NAME=${{ secrets.DEFAULT_USER_NAME }} \
            --build-arg DEFAULT_USER_ROLE=${{ secrets.DEFAULT_USER_ROLE }} \
            --build-arg DEFAULT_USER_EMAIL=${{ secrets.DEFAULT_USER_EMAIL }} \
            --build-arg DEFAULT_USER_PASSWORD=${{ secrets.DEFAULT_USER_PASSWORD }} \
            --build-arg MAIL_HOST=${{ secrets.MAIL_HOST }} \
            --build-arg MAIL_USER=${{ secrets.MAIL_USER }} \
            --build-arg MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }} \
            --build-arg MAIL_FROM=${{ secrets.MAIL_FROM }} \
            --build-arg MAIL_PORT=${{ secrets.MAIL_PORT }} \
            --build-arg MAIL_BREVO_API_KEY=${{ secrets.MAIL_BREVO_API_KEY }} \
            --build-arg BCRYPTJS_SALT_ROUNDS=${{ secrets.BCRYPTJS_SALT_ROUNDS }} \
            -f Dockerfile.prod --target production \
            -t ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-${{ steps.set-env.outputs.image_tag }}:${{ github.sha }} .
        # github.sha: Automatic variable containing the commit hash (unique identifier)
        # Example result: username/api-gifty-nestjs-production:abc123def456

      # Step 5: Create an additional tag called 'latest' pointing to the same image
      # Purpose: Keep a stable tag that always points to the most recent version
      # This allows Render or other services to always pull the latest version
      - name: Tag the Docker image
        run: docker tag ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-${{ steps.set-env.outputs.image_tag }}:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-${{ steps.set-env.outputs.image_tag }}:latest

      # Step 6: Upload the image to Docker Hub registry
      # Only pushes the ':latest' tag, which also uploads the underlying image
      # Render will detect this new ':latest' tag and trigger automatic deployment
      - name: Push the Docker image to Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-${{ steps.set-env.outputs.image_tag }}:latest

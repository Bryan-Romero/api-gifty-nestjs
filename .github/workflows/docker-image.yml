name: Build and Push Docker Image

on:
  push:
    branches: [main, production]
  # pull_request:
  #   branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build the Docker image
        env:
          PORT: ${{ secrets.PORT }}
          API_KEY: ${{ secrets.API_KEY }}
          PREFIX: ${{ secrets.PREFIX }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
          REFRESH_JWT_SECRET: ${{ secrets.REFRESH_JWT_SECRET }}
          REFRESH_JWT_EXPIRES_IN: ${{ secrets.REFRESH_JWT_EXPIRES_IN }}
          MAIL_JWT_SECRET: ${{ secrets.MAIL_JWT_SECRET }}
          MAIL_JWT_EXPIRES_IN: ${{ secrets.MAIL_JWT_EXPIRES_IN }}
          PASSWORD_JWT_SECRET: ${{ secrets.PASSWORD_JWT_SECRET }}
          PASSWORD_JWT_EXPIRES_IN: ${{ secrets.PASSWORD_JWT_EXPIRES_IN }}
          DATABASE_URI: ${{ secrets.DATABASE_URI }}
          DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
          DEFAULT_USER_NAME: ${{ secrets.DEFAULT_USER_NAME }}
          DEFAULT_USER_ROLE: ${{ secrets.DEFAULT_USER_ROLE }}
          DEFAULT_USER_EMAIL: ${{ secrets.DEFAULT_USER_EMAIL }}
          DEFAULT_USER_PASSWORD: ${{ secrets.DEFAULT_USER_PASSWORD }}
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          BCRYPTJS_SALT_ROUNDS: ${{ secrets.BCRYPTJS_SALT_ROUNDS }}
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-production:${{ github.sha }} .
        # github.sha
        # Esta variable es automática y la proporciona GitHub en cada ejecución de GitHub Actions.
        # Representa el hash del commit actual, útil para etiquetar imágenes de Docker con un identificador único

      - name: Verificar valores de las variables
        run: |
          echo "PORT=${{ secrets.PORT }}"
          echo "DATABASE_URI=${{ secrets.DATABASE_URI }}"

      - name: Tag the Docker image
        run: docker tag ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-production:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-production:latest

      - name: Push the Docker image to Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/api-gifty-nestjs-production:latest

name: Deploy to Railway

# Trigger: This workflow runs automatically AFTER another workflow completes
# It waits for 'Build and Push Docker Image' workflow to finish successfully
on:
  workflow_run:
    workflows: ['Build and Push Docker Image']
    types:
      - completed # Triggers when the specified workflow finishes (success or failure)

jobs:
  deploy:
    # Runner: Uses the latest Ubuntu virtual machine provided by GitHub
    runs-on: ubuntu-latest

    # Environment selection: Uses 'development' for dev branch, 'production' for main/production
    # This allows using the same secret names with different values per environment
    environment:
      name: ${{ github.ref == 'refs/heads/dev' && 'development' || 'production' }}

    steps:
      # Step 1: Clone the repository code into the runner
      # This allows access to repository context and branch information
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install Railway CLI globally using npm
      # Railway CLI: Command-line tool to interact with Railway platform
      # -g flag: Installs the package globally, making it available system-wide
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      # Step 3: Authenticate Railway CLI with your Railway account
      # RAILWAY_API_TOKEN: Secret token that identifies and authorizes your account
      # railway whoami: Verifies authentication by displaying the logged-in user info
      # Purpose: Ensures GitHub Actions can execute Railway commands on your behalf
      # Note: Same secret name (RAILWAY_API_TOKEN) used for both environments
      - name: Authenticate Railway CLI
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: railway whoami

      # Step 4: Link this workflow to a specific Railway project/service
      # --service: The specific service within Railway to deploy (e.g., api-backend)
      # --project_id: The Railway project ID that contains your service
      # --environment: The environment to deploy to (e.g., production, staging, development)
      # Purpose: Tells Railway CLI exactly WHERE to deploy the new Docker image
      # Note: All Railway IDs use the same secret names, but values differ per environment
      - name: Link Railway project
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: railway link --service=${{ secrets.RAILWAY_SERVICE_ID }} --project_id=${{ secrets.RAILWAY_PROJECT_ID }} --environment=${{ secrets.RAILWAY_ENVIRONMENT_ID }}

      # Step 5: Trigger a redeployment of the latest Docker image on Railway
      # railway redeploy: Pulls the latest Docker image from Docker Hub and deploys it
      # --yes: Automatically confirms the deployment without manual approval
      # Purpose: Updates the running service with the newly built Docker image
      - name: Deploy latest Docker image to Railway
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: railway redeploy --yes
